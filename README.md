# PU-Auto-Message

**PU口袋校园活动自动监听与提醒助手**

PU-Auto-Message 是一个基于 Python 的自动化脚本，专为高校学生设计。它能够智能监控 PU口袋校园平台上的活动更新，支持区分“社团活动”与“公共活动”，并根据活动的热度智能调整通知频率。脚本支持将变更信息以 Markdown 格式（Base64编码）推送到指定的 Webhook 接口（如 PHP 转发端、Telegram Bot 等），或直接在本地控制台输出。

## ✨ 核心功能

* **🛡️ 智能鉴权与重试**：内置 Token 鉴权，支持自动处理网络超时与重试机制。
* **🎯 精准过滤**：
    * **年级/学院过滤**：自动剔除不符合年级 (`ALLOW_YEARS`) 或学院 (`TARGET_COLLEGE_ID`) 要求的公共活动。
    * **关键词屏蔽**：支持自定义标题关键词 (`FILTER_KEYWORDS`) 屏蔽不感兴趣的活动。
* **🧠 智能通知策略**：
    * **社团优先**：我加入的社团/组织活动，无论大小，一律发送详细通知。
    * **公共活动限流**：针对“大型公共活动”（名额>700且时长>10天），采用智能限流策略。前3次详细通知，后续积攒每80人才发送一次简略通知，避免刷屏。
* **⏰ 运行时间窗口**：仅在每日 `07:30 ~ 22:00` 期间运行，深夜自动休眠。
* **📉 差异化刷新**：社团活动每 20 分钟检查一次，公共活动每 30 分钟检查一次，降低接口请求频率，减少风控风险。
* **📨 多样化推送**：支持将活动详情打包为 Markdown -> Base64 -> POST 请求发送给服务端。

## 🛠️ 环境依赖

* Python 3.6+
* 第三方库：`requests`

```bash
pip install requests
```

## ⚙️ 配置说明 (Configuration)

在使用前，请打开脚本主文件，修改顶部的配置区域：

### 1. 基础鉴权

```python
# 抓包获取你的 Authorization 字段
AUTHORIZATION = "Bearer your_token_here" 
```

### 2. 筛选规则 (必需修改)

```python
# 允许的年级 ID (抓包查看 list 接口参数)
ALLOW_YEARS = [123456789101112]

# 你的学院 ID (非此学院的受限公共活动将被自动过滤)
TARGET_COLLEGE_ID = 123456789101112

# 标题关键词过滤 (包含这些词的活动直接忽略)
FILTER_KEYWORDS = ["讲座签到测试", "不加分"]
```

### 3. 推送设置

脚本会将 Markdown 内容进行 Base64 编码，并通过 POST 请求发送到以下地址：

```python
# 接收端示例：http://127.0.0.1/message.php
# 脚本会自动剔除 URL 中的参数部分，以 POST body {"msg": "base64_string"} 发送
DIFF_LOG_URL = "http://127.0.0.1/message.php"
```

> **注意**：如果 `DIFF_LOG_URL` 为空，脚本将自动切换为 **控制台输出模式**，方便本地调试。

### 4. 智能限流阈值 (可选调整)

```python
LARGE_ACT_CAPACITY_LIMIT = 700   # 定义大型活动：人数上限 > 700
LARGE_ACT_DURATION_DAYS = 10     # 定义大型活动：持续天数 > 10天
MAX_LARGE_DETAIL_COUNT = 3       # 大型活动：详细通知的前3次机会
LARGE_NOTIFY_BATCH = 80          # 大型活动：后续每积攒 80 人通知一次
```

## 🚀 使用方法

### 1. 手动运行

```bash
python main.py
```

### 2. 设置定时任务 (Crontab)

建议设置为每 10 分钟运行一次。脚本内部会自动判断当前时间是否需要执行具体逻辑（社团20分钟间隔/公共30分钟间隔）。

```bash
# 编辑 crontab
crontab -e

# 添加如下行 (每10分钟执行一次)
*/10 * * * * /usr/bin/python3 /path/to/your/script/main.py >> /path/to/log/cron.log 2>&1
```

## 📊 通知效果示例

脚本推送的消息为 Markdown 格式，解码渲染后效果如下：

---

**🔥 火热报名中 (新增 +105人)**
### 【公共】大学生创新创业大赛讲座
> 本次讲座特邀知名企业家...

* **报名时间**：12-16 08:00 ~ 12-20 18:00
* **报名人数**：上限 500 | 已报名 320 | 已签到 0
* **活动时间**：12-21 14:00 ~ 12-21 16:00
* **状态**：报名中
* **主办/所属**：创新创业学院
* **学分 / PU银豆**：0.5 / 10
* **附件**：[讲座须知.pdf](http://...)

---

## 📂 数据存储

脚本会在指定路径（默认为 `./pu_monitor_cache.json`）生成一个 JSON 文件，用于存储：
* 上次运行时间
* 活动的历史报名人数（用于计算增量）
* 大型活动的通知计数状态

请确保脚本对该目录有**写入权限**。

## ⚠️ 免责声明

1.  本项目仅供学习交流使用，请勿用于商业用途。
2.  脚本涉及使用 User Token，请妥善保管你的 Token，不要泄露给他人。
3.  使用自动化工具可能违反平台的服务条款，请合理设置请求频率，避免对服务器造成压力或导致账号被风控。
